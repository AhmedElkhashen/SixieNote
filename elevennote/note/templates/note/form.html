{% extends "base.html" %}

{% block extra_head %}
{% load wysiwyg %}
{% wysiwyg_setup %}

    <script src="https://fb.me/react-0.13.3.js"></script>
    <script src="https://fb.me/JSXTransformer-0.13.3.js"></script>

{% endblock %}

{% block content %}

    <div class="row">

        <div class="col-xs-4">
            <nav id="sidebar">

              <div class="new-note">
                <a href="{% url 'note:create' %}" class="new-note btn btn-default">+ New Note</a>
              </div>

	      <div id="notes">

	      </div>
            </nav>
        </div>

        <div class="col-xs-8">

        {% if form.errors %}
            {% for error in form.non_field_errors %}
                <div class="alert alert-danger" role="alert">
                    <strong>{{ error|escape }}</strong>
                </div>
            {% endfor %}
        {% endif %}

        {% if object %}
        <form action="{% url 'note:update' object.pk %}" method="post" accept-charset="utf-8">
        {% else %}
        <form action="{% url 'note:create' %}" method="post" accept-charset="utf-8">
        {% endif %}

            {% csrf_token %}
            {% for field in form %}
            <p>
                {% if field.errors %}
            	<div class="alert alert-danger" role="alert">
                    {{ field.errors }}
            	</div>
                {% endif %}
                {{ field }}
            </p>
            {% endfor %}
            <input type="hidden" name="next" value="{{ next }}" />

        {% if object %}
            <input class="btn btn-default" type="submit" value="Update Note"/>
        {% else %}
            <input class="btn btn-default" type="submit" value="Create Note"/>
        {% endif %}
        </form>

	{% if object %}
	  <form action="{% url 'note:delete' object.pk %}" method="post" id="delete-note-form">
            {% csrf_token %}
            <a class="btn btn-default" id="delete-note">
	      <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
	    </a>
	  </form>
	{% endif %}
	    

        </div>
    </div>

{% wysiwyg_editor "id_body" %}

    <script type="text/jsx">

var NoteBox = React.createClass({
  getInitialState: function() {
    return {data: []};
  },
  componentDidMount: function() {
    $.ajax({
      url: this.props.url,
      dataType: 'json',
      cache: false,
      success: function(data) {
        this.setState({data: data.objects});
      }.bind(this),
      error: function(xhr, status, err) {
        console.error(this.props.url, status, err.toString());
      }.bind(this)
    });
  },
  render: function() {
    return (
        <NoteList data={this.state.data} />
    );
  },
  componentDidUpdate: function() {
    $("#notes li").click(function(){
        location.assign($(this).attr("data-url"));
    });
  }
});

var NoteList = React.createClass({
  render: function() {
    var noteNodes = this.props.data.map(function (note) {
      return (
        <Note title={note.title} id={note.id}>
          {note.body}
        </Note>
      );
    });
    return (
      <ul id="notes">
	{noteNodes}
      </ul>
    );
  }
});

var Note = React.createClass({
  render: function() {
    var rawBody = this.props.children.toString();
    var editUrl = "/notes/" + this.props.id + "/";
    return (
      <li data-url={ editUrl }>
	<div className="note-title">{ this.props.title }</div>
        <div className="note-body" dangerouslySetInnerHTML={ {__html: rawBody} } />
      </li>
    );
  }
});

React.render(
  <NoteBox url="/api/v1/note/?format=json&username={{ request.user }}&api_key={{ apikey }}" />,
  document.getElementById('notes')
);

    </script>

{% endblock %}
